<!DOCTYPE html>
<html>
<head>
  <title>Editor â€“ ColorCraz</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
  <style>
    body{margin:0;background:#111;color:white;font-family:Inter,sans-serif;}
    .toolbar{position:fixed;top:0;left:0;right:0;background:rgba(0,0,0,0.9);padding:15px;z-index:10;text-align:center;}
    button{margin:0 10px;padding:12px 24px;background:#6e6eff;border:none;border-radius:50px;color:white;cursor:pointer;}
    #canvas{position:relative;width:1080px;height:1080px;margin:80px auto;background:#222;overflow:hidden;border:2px dashed #444;}
    #bg{width:100%;height:100%;object-fit:contain;}
    .text-el{position:absolute;font-size:60px;font-weight:900;color:#6e6eff;cursor:move;user-select:none;text-shadow:2px 2px 10px rgba(0,0,0,0.7);}
  </style>
</head>
<body>
<div class="toolbar">
  <button onclick="addText()">Add Text</button>
  <button onclick="saveDesign()">Save Design</button>
  <button onclick="download()">Download PNG</button>
  <button onclick="location.href='dashboard.html'">Dashboard</button>
</div>
<div id="canvas">
  <img id="bg">
</div>

<script>
  const supabase = Supabase.createClient(
          'https://enjczoepifvolmqooccd.supabase.co',
          'sb_publishable_uEMVu8A5fHuDxuHqWC-4A_PceL8yGI'
  );

  const bg = document.getElementById('bg');
  bg.src = localStorage.getItem('templateImage') || 'https://images.unsplash.com/photo-1550745162-2b8b5c4f5c8f?w=1080';

  function addText() {
    const el = document.createElement('div');
    el.className = 'text-el';
    el.contentEditable = true;
    el.innerText = 'YOUR TEXT HERE';
    el.style.left = '100px'; el.style.top = '100px';
    document.getElementById('canvas').appendChild(el);
    makeDraggable(el);
    el.focus();
  }

  function makeDraggable(el) {
    let pos1=0,pos2=0,pos3=0,pos4=0;
    el.onmousedown = e => {
      e.preventDefault();
      pos3 = e.clientX; pos4 = e.clientY;
      document.onmouseup = () => document.onmousemove = null;
      document.onmousemove = e => {
        pos1 = pos3 - e.clientX; pos2 = pos4 - e.clientY;
        pos3 = e.clientX; pos4 = e.clientY;
        el.style.top = (el.offsetTop - pos2) + "px";
        el.style.left = (el.offsetLeft - pos1) + "px";
      };
    };
  }

  async function saveDesign() {
    const { data: { user } } = await supabase.auth.getUser();
    if (!user) { alert('Please log in first'); location.href='auth.html'; return; }

    const thumbnail = await html2canvas(document.getElementById('canvas'), {scale:0.5}).then(c => c.toDataURL());
    const name = prompt('Design name?', 'My Awesome Design') || 'My Awesome Design';

    const { error } = await supabase
            .from('designs')
            .insert({
              user_id: user.id,
              name,
              thumbnail,
              data: JSON.stringify({}) // future: save text positions
            });

    if (error) alert('Error: ' + error.message);
    else { confetti({particleCount:200,spread:70,origin:{y:0.6}}); alert('Saved!'); }
  }

  function download() {
    html2canvas(document.getElementById('canvas')).then(canvas => {
      const a = document.createElement('a');
      a.download = 'colorcraz-design.png';
      a.href = canvas.toDataURL();
      a.click();
    });
  }
</script>
</body>
</html>